<script>
        const video = document.getElementById('webcam');
        const canvas = document.getElementById('canvas');
        let currentStream;
        let facingMode = 'user'; // user = กล้องหน้า, environment = กล้องหลัง

        // 1. เริ่มต้นเปิดกล้อง
        async function startCamera() {
            if (currentStream) {
                currentStream.getTracks().forEach(track => track.stop());
            }
            try {
                const constraints = {
                    video: { 
                        facingMode: facingMode,
                        width: { ideal: 1080 },
                        height: { ideal: 1920 } 
                    },
                    audio: false
                };
                currentStream = await navigator.mediaDevices.getUserMedia(constraints);
                video.srcObject = currentStream;
                
                // รอให้วิดีโอพร้อมเล่นจริงๆ ก่อน
                video.onloadedmetadata = () => {
                    video.play();
                };

                // กลับด้านเฉพาะกล้องหน้า
                video.style.transform = facingMode === 'user' ? 'scaleX(-1)' : 'scaleX(1)';

            } catch (err) {
                alert("❌ เปิดกล้องไม่ได้: " + err.name + "\n(ลองเปิดผ่าน HTTPS หรือกดอนุญาตกล้อง)");
                console.error(err);
            }
        }

        // 2. สลับกล้อง
        function switchCamera() {
            facingMode = facingMode === 'user' ? 'environment' : 'user';
            startCamera();
        }

        // 3. ถ่ายรูป (ฉบับแก้บัค: หากรอบไม่เจอก็ถ่ายได้)
        function takePhoto() {
            try {
                // เอฟเฟกต์แฟลช
                const flash = document.createElement('div');
                flash.style.position = 'fixed'; flash.style.top = 0; flash.style.left = 0;
                flash.style.width = '100%'; flash.style.height = '100%';
                flash.style.background = 'white'; flash.style.zIndex = '9999';
                flash.style.transition = 'opacity 0.2s';
                document.body.appendChild(flash);
                setTimeout(() => { flash.style.opacity = '0'; setTimeout(()=>flash.remove(), 200); }, 50);

                const context = canvas.getContext('2d');

                // ตั้งขนาด Canvas ตามขนาดจริงของวิดีโอที่เข้ามา
                if (video.videoWidth === 0) {
                    alert("กล้องยังไม่พร้อมครับ ลองใหม่อีกครั้ง");
                    return;
                }
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;

                // A. วาดภาพจากกล้อง
                if (facingMode === 'user') {
                    context.translate(canvas.width, 0);
                    context.scale(-1, 1);
                }
                context.drawImage(video, 0, 0, canvas.width, canvas.height);
                context.setTransform(1, 0, 0, 1, 0, 0); // Reset กลับ

                // B. วาดกรอบ (ดึงจากหน้าจอโดยตรง เพื่อความชัวร์)
                const frameOnScreen = document.querySelector('.overlay-frame-img');
                
                // เช็คว่ารูปกรอบโหลดเสร็จหรือยัง
                if (frameOnScreen && frameOnScreen.complete && frameOnScreen.naturalHeight !== 0) {
                    context.drawImage(frameOnScreen, 0, 0, canvas.width, canvas.height);
                } else {
                    console.log("⚠️ หากรอบไม่เจอ หรือรูปยังโหลดไม่เสร็จ (ถ่ายแบบไม่มีกรอบแทน)");
                }

                // C. แสดงผล
                const dataUrl = canvas.toDataURL('image/png');
                document.getElementById('resultImg').src = dataUrl;
                document.getElementById('downloadLink').href = dataUrl; // สำหรับ Android/PC
                document.getElementById('resultModal').style.display = 'flex';

            } catch (e) {
                alert("เกิดข้อผิดพลาดตอนถ่าย: " + e.message);
            }
        }

        function closeModal() {
            document.getElementById('resultModal').style.display = 'none';
        }

        // เริ่มทำงาน
        window.onload = startCamera;
    </script>